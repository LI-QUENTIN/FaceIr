# 人脸识别系统
## 环境配置

建议预先装 Anaconda，否则 dlib 库冲突很难处理

```shell
pip install opencv-python
pip install cmake
pip install numpy
```

管理员打开终端，输入：`conda install -c conda-forge dlib`

接着切回普通终端：

```shell
pip install dlib
pip install face_recognition
pip install PyQt5
```

## 技术栈

本应用主要使用以下技术和库：

- **Python**: 核心编程语言。
- **PyQt5**: 用于构建桌面图形用户界面 (GUI)，提供了跨平台的 UI 框架。
- **OpenCV**: 一个强大的计算机视觉库，用于处理实时视频流、捕获摄像头数据和在帧上绘制人脸识别框。
- **`face_recognition`**: 一个基于深度学习的轻量级人脸识别库，它简化了人脸检测、编码和比对的流程。
- **多线程 (QThread)**: 用于将耗时的人脸识别和视频流处理任务与主 GUI 线程分离，确保界面保持响应和流畅。
- **`numpy`**: 用于高效地处理人脸编码等数值数据。
- **`json`**: 用于将人脸数据（编码和名称）序列化和反序列化，实现数据的持久化存储。

## 设计思路

本应用的设计目标是提供一个直观、流畅且功能强大的人脸识别体验。主要设计思路如下：

### 1. UI/UX 设计

- **现代风格**: 界面采用深色主题和圆角设计，提供了现代化的视觉体验。
- **分离式布局**: 将视频显示区、控制按钮和已加载人脸列表分置在不同区域，结构清晰。左侧的侧边栏提供了已加载人脸的概览和删除功能，右侧主区域用于显示视频流和控制按钮，这种布局让用户可以一目了然地了解应用状态并进行操作。

### 2. 多线程处理

为了防止耗时操作（如人脸识别）阻塞主界面，应用采用了多线程设计：

- **`VideoThread`**: 这是一个专门用于从摄像头捕获视频帧并进行人脸识别的线程。它独立于主 GUI 线程运行，通过 `pyqtSignal` 信号将处理后的帧发送回主线程进行显示，确保视频流的流畅性，并防止界面卡顿。
- **`ImageProcessingThread`**: 这是一个用于处理用户上传的静态图片文件的线程。由于加载和处理图片同样需要时间，此线程避免了在处理图片时主界面的冻结，处理完成后通过信号通知主线程更新 UI。

### 3. 持久化存储和管理

应用的另一个核心设计是人脸数据的持久化存储，以便在应用关闭后下次仍能使用：

- **数据存储**: 所有已知人脸的编码和名称都保存在一个名为 `known_faces.json` 的文件中。人脸编码是高维的 `numpy` 数组，在保存到 JSON 文件之前，会被转换为 Python 原生列表，以便于序列化。
- **数据管理**: `data_manager.py` 模块专门负责处理数据的加载和保存，将这部分逻辑与 UI 代码分离，提高了代码的可维护性。
- **动态更新**: 当用户上传新照片或删除已有人脸时，应用会即时更新内存中的人脸数据，并自动保存到 JSON 文件中，确保数据始终是最新状态。

## 关键功能逻辑

### 1. 照片上传与人脸添加

- **摄像头状态检查**: 在用户上传照片时，应用会首先检查摄像头是否处于开启状态。如果开启，它会先关闭摄像头，以避免资源冲突。
- **多线程处理**: 用户选择照片后，`ImageProcessingThread` 线程开始在后台处理图片。它会检测图片中的人脸并生成人脸编码。
- **重复人脸检查**: 在将新人脸添加到数据库之前，应用会与所有已知人脸进行比对，以避免重复添加同一张人脸。
- **UI 反馈**: 处理过程中，状态标签 (`info_label`) 会显示“正在处理图像...”，为用户提供即时反馈。处理完成后，会显示成功或失败的消息。

### 2. 摄像头控制

- **单按钮控制**: “打开摄像头”和“关闭摄像头”功能集成在一个按钮上，根据摄像头当前状态自动切换文本和功能。
- **多线程视频流**: 当摄像头打开时，`VideoThread` 线程启动。它不断从摄像头捕获帧，进行人脸识别，并将带有人脸框和名称的帧发送到主界面更新。
- **资源释放**: 当用户点击“关闭摄像头”或关闭应用窗口时，`closeEvent` 函数会负责停止 `VideoThread` 确保正确释放摄像头资源，防止下次启动时出现“摄像头已被占用”的错误。

### 3. 人脸数据管理

- **侧边栏列表**: 界面左侧的侧边栏动态显示所有已加载的人脸名称。
- **删除功能**: 列表中的每个条目旁边都有一个“删除”按钮。点击该按钮会触发 `delete_face` 方法，该方法会从内存中的人脸数据列表和 `known_faces.json` 文件中删除对应的人脸，并重新加载侧边栏列表，实现界面的实时更新。
